// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum RoleDefault {
  passenger
  driver
}

enum AuthProvider {
  google
  apple
}

enum RideStatus {
  open
  ongoing
  completed
  cancelled
}

enum BookingStatus {
  pending
  confirmed
  cancelled_by_passenger
  cancelled_by_driver
  completed
  ACCEPTED
  PAYMENT_PENDING
  CONFIRMED
}

enum PaymentStatus {
  unpaid
  paid
  refunded
  pending
  succeeded
  failed
}

enum NotificationType {
  ride_update
  payment
  system
}

enum DevicePlatform {
  ios
  android
  web
}

enum DriverDocumentType {
  license
  insurance
  ownership
  other
}

enum DriverDocumentStatus {
  pending
  approved
  rejected
}

model DriverDocument {
  id        String               @id @default(uuid())
  user      User                 @relation(fields: [userId], references: [id])
  userId    String
  type      DriverDocumentType
  s3Key     String
  fileName  String
  mimeType  String
  status    DriverDocumentStatus @default(pending)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
}

model User {
  id                        String           @id @default(uuid())
  name                      String
  email                     String           @unique
  phone                     String?          @unique
  passwordHash              String?
  roleDefault               RoleDefault      @default(passenger)
  providerAvatarUrl         String?
  emailVerified             Boolean          @default(false)
  stripeAccountId           String?          @unique

  // ðŸ”½ NEW FIELDS FOR EMAIL OTP
  emailVerifyOtp            String?
  emailVerifyOtpExpiresAt   DateTime?
  emailVerifyOtpAttempts    Int              @default(0)
  passwordResetOtp          String?
  passwordResetOtpExpiresAt DateTime?
  passwordResetOtpAttempts  Int              @default(0)

  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt

  oauthAccounts        OAuthAccount[]
  driverProfile        DriverProfile?
  rides                Ride[]           @relation("DriverRides")
  bookings             Booking[]        @relation("PassengerBookings")
  notifications        Notification[]
  sosEvents            SosEvent[]
  rideRequests         RideRequest[]
  acceptedRideRequests RideRequest[]     @relation("AcceptedRideRequestDriver")
  rideRequestOffers    RideRequestOffer[]
  driverDocuments      DriverDocument[]
  refreshTokens        RefreshToken[]
  passengerConversations Conversation[] @relation("PassengerConversations")
  driverConversations    Conversation[] @relation("DriverConversations")
  messages               Message[]
  deviceTokens           DeviceToken[]
}

model OAuthAccount {
  id               String       @id @default(uuid())
  user             User         @relation(fields: [userId], references: [id])
  userId           String
  provider         AuthProvider
  providerUserId   String
  providerEmail    String
  accessToken      String?
  refreshToken     String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([provider, providerUserId])
}

model RefreshToken {
  id                 String   @id @default(uuid())
  user               User     @relation(fields: [userId], references: [id])
  userId             String
  tokenHash          String   @unique
  expiresAt          DateTime
  revokedAt          DateTime?
  replacedByTokenId  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

model DriverProfile {
  id            String   @id @default(uuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @unique
  carMake       String?
  carModel      String?
  carYear       String?   // NEW
  carColor      String?
  plateNumber   String?
  licenseNumber String?
  insuranceInfo String?   // NEW
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Ride {
  id              String       @id @default(uuid())
  driver          User         @relation("DriverRides", fields: [driverId], references: [id])
  driverId        String
  fromCity        String
  fromLat         Float
  fromLng         Float
  toCity          String
  toLat           Float
  toLng           Float
  startTime       DateTime
  arrivalTime     DateTime?
  pricePerSeat    Decimal      @db.Decimal(10, 2)
  seatsTotal      Int
  seatsAvailable  Int
  status          RideStatus   @default(open)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  bookings        Booking[]
  sosEvents       SosEvent[]
  conversations   Conversation[]
  rideRequestOffers RideRequestOffer[]
}

model FixedRoutePrice {
  id           String   @id @default(uuid())
  fromCity     String
  toCity       String
  pricePerSeat Decimal  @db.Decimal(10, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fromCity])
  @@index([toCity])
}

model Booking {
  id                    String         @id @default(uuid())
  ride                  Ride           @relation(fields: [rideId], references: [id])
  rideId                String
  passenger             User           @relation("PassengerBookings", fields: [passengerId], references: [id])
  passengerId           String
  seatsBooked           Int
  passengerPickupName   String?
  passengerPickupLat    Float?
  passengerPickupLng    Float?
  passengerDropoffName  String?
  passengerDropoffLat   Float?
  passengerDropoffLng   Float?
  status                BookingStatus  @default(pending)
  paymentStatus         PaymentStatus  @default(unpaid)
  stripePaymentIntentId String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  payments              Payment[]
}


model Payment {
  id                     String        @id @default(uuid())
  booking                Booking       @relation(fields: [bookingId], references: [id])
  bookingId              String
  paymentIntentId        String        @unique
  amountCents            Int
  platformFeeCents       Int
  currency               String        @default("cad")
  status                 PaymentStatus @default(pending)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  @@index([bookingId])
}

model Notification {
  id          String           @id @default(uuid())
  user        User             @relation(fields: [userId], references: [id])
  userId      String
  title       String
  body        String
  type        NotificationType @default(system)
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
}

model DeviceToken {
  id        String          @id @default(uuid())
  user      User            @relation(fields: [userId], references: [id])
  userId    String
  token     String          @unique
  platform  DevicePlatform?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([userId])
}

model SosEvent {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  ride      Ride?    @relation(fields: [rideId], references: [id])
  rideId    String?
  lat       Float
  lng       Float
  createdAt DateTime @default(now())
}

model Conversation {
  id                 String    @id @default(uuid())
  ride               Ride?     @relation(fields: [rideId], references: [id])
  rideId             String?
  passenger          User      @relation("PassengerConversations", fields: [passengerId], references: [id])
  passengerId        String
  driver             User      @relation("DriverConversations", fields: [driverId], references: [id])
  driverId           String
  lastMessageAt      DateTime?
  lastMessagePreview String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  messages           Message[]

  @@index([passengerId])
  @@index([driverId])
  @@index([rideId])
  @@unique([rideId, passengerId, driverId])
}

model Message {
  id             String       @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         User         @relation(fields: [senderId], references: [id])
  senderId       String
  body           String
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
}

enum RideRequestStatus {
  PENDING
  OFFERING
  ACCEPTED
  CANCELLED
  EXPIRED
  pending
  matched
  cancelled
  expired
}

enum RideRequestOfferStatus {
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  pending
  accepted
  rejected
  cancelled
}

model RideRequest {
  id             String            @id @default(uuid())
  passenger      User              @relation(fields: [passengerId], references: [id])
  passengerId    String
  driver         User?             @relation("AcceptedRideRequestDriver", fields: [driverId], references: [id])
  driverId       String?

  fromCity       String
  fromLat        Float
  fromLng        Float
  toCity         String
  toLat          Float
  toLng          Float

  preferredDate  DateTime
  preferredTime  String?           // e.g. "08:00"
  arrivalTime    String?           // optional preferred arrival

  seatsNeeded    Int

  // For now as strings: "one-time" | "recurring"
  rideType       String            // you can later make this an enum
  // "one-way" | "round-trip"
  tripType       String

  returnDate     DateTime?
  returnTime     String?

  status         RideRequestStatus @default(PENDING)

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  offers         RideRequestOffer[]

  @@index([status])
  @@index([fromCity])
  @@index([toCity])
  @@index([fromLat, fromLng])
  @@index([passengerId])
  @@index([driverId])
}

model RideRequestOffer {
  id             String                  @id @default(uuid())
  rideRequest    RideRequest             @relation(fields: [rideRequestId], references: [id])
  rideRequestId  String
  driver         User                    @relation(fields: [driverId], references: [id])
  driverId       String
  ride           Ride?                   @relation(fields: [rideId], references: [id])
  rideId         String?
  seatsOffered   Int
  pricePerSeat   Decimal                 @db.Decimal(10, 2)
  status         RideRequestOfferStatus  @default(SENT)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  @@index([rideRequestId])
  @@index([driverId])
  @@index([rideId])
  @@unique([rideRequestId, driverId])
}
